# invioceAdd

### Данный скрипт позволяет выставить счет и отправить ссылку на оплату средствами Битрикс24.

Скрипт позволяет выставить частичный счет на оплату клиенту, если клиент попросил рассрочку. Скрипт также может быть использован для полной оплаты клиентом.

**Механизм работы**:

1. При достижении определенного этапа запускается вебхук, который из сделки получает сумму оплаты по клиенту.
2. На основании сделки выставляется счет как сущность клиенту. 
3. На основании выставленного счета формируется ссылка на оплату клиенту с помощью подключенной кассы к Битрикс24.
4. Записываем в карту сделки ссылку на оплату. Далее бизнес-процесс подхватывает ссылку на оплату и отправляет ее клиенту.

Решение может работать как на облачных, так и коробочных Битрикс24. 

**Как запустить**:
1. invioceAdd.php и auth.php необходимо разместить на хостинге с поддержкой SSL.
2. В разделе "Разработчикам" необходимо создать входящий вебхук с правами на CRM (crm). Подробнее как создать входящий / исходящий вебхук: [Ссылки на документацию 1С-Битрикс](https://github.com/thnik911/invioceAdd/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81).
3. Полученный "Вебхук для вызова rest api" прописать в auth.php.
4. Необходимо создать товар внутри Битрикс24, который будет иметь название любое название. Цена товара может быть любой, назначается из сделки. Как создать товар:[Ссылки на документацию 1С-Битрикс](https://github.com/thnik911/invioceAdd/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81). ID товара необходимо прописать в строке 47 скрипта invioceAdd.php
5. Необходимо создать дополнительное поле в сделке с типом "Число". Код поля прописать в строке 21 invioceAdd.php вместо 'UF_CRM_1612278529'. Как создать дополнительное поле: [Ссылки на документацию 1С-Битрикс](https://github.com/thnik911/invioceAdd/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81). В данном поле будет храниться сумма счета.
6. В строке 35 скрипта invioceAdd.php необходимо указать ID компании, от которой выставляется счет, то есть, наша компания. Подробнее о том как добавить реквизиты нашей компании: [Ссылки на документацию 1С-Битрикс](https://github.com/thnik911/invioceAdd/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81) 
7. В строке 37 крипта invioceAdd.php необходимо указать ID платженой системы. Подробнее о том, как подключить платежную систему: [Ссылки на документацию 1С-Битрикс](https://github.com/thnik911/invioceAdd/blob/main/README.md#%D1%81%D1%81%D1%8B%D0%BB%D0%BA%D0%B8-%D0%BD%D0%B0-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%B0%D1%86%D0%B8%D1%8E-1%D1%81-%D0%B1%D0%B8%D1%82%D1%80%D0%B8%D0%BA%D1%81) 
8. Необходимо создать 2 дополнительных поля в карточке сделки. Первое поле с типом "число", в нем будет храниться ID счета, второе - с типом "ссылка", в нем будет храниться ссылка на оплату.
9. Коды созданных полей нужно прописать в крипта invioceAdd.php. В строке 72 вместо кода поля 'UF_CRM_1612517885' указываем свой код поля с типом "ссылка". В строке 73 вместо кода поля 'UF_CRM_1612789625' указываем свой код поля с типом "число".
10. Делаем POST запрос посредством конструкции Webhook* через робот, или бизнес-процессом: https://yourdomain.com/path/invioceAdd.php?deal=123&cnt=456&user=789

Переменные передаваемые в POST запросе:

yourdomain.com - адрес сайта, на котором размещены скрипты auth.php и invioceAdd.php с поддержкой SSL.

path - путь до скрипта.

deal - ID сделки.

cnt - ID конакта, который связан со сделкой.

user - ID ответственного за сделку.

### Ссылки на документацию 1С-Битрикс 

<details><summary>Развернуть список</summary>

1. Действие Webhook внутри Бизнес-процесса / робота https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=57&LESSON_ID=8551
2. Как создать Webhook https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=99&LESSON_ID=8581&LESSON_PATH=8771.8583.8581
3. Создать товар внутри Битрикс24 https://helpdesk.bitrix24.ru/open/11657084/
4. Создать дополнительное поле в Битрикс24 https://helpdesk.bitrix24.ru/open/5488795/
5. Как добавить реквизиты своей компании https://helpdesk.bitrix24.ru/open/2025947/
6. Подключение платежной системы https://helpdesk.bitrix24.ru/open/5429733/

</details>
